<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta name="generator" content="pandoc" />




<link rel="stylesheet" href="../../../style.css" type="text/css" />



<script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script>
jQuery(document).ready(function(){
    jQuery('pre').each(function(){
        var el = jQuery(this).find('code');
        var code_block = el.html(); 
 
        if (el.length > 0) { 
            jQuery(this).addClass('prettyprint').html(code_block).attr('style', 'max-height:450px');
        } else { 
            jQuery(this).removeClass().addClass('prettyprint'); 
        }
    });
});
</script>

<script type="text/javascript" src="../../run_prettify.js"></script>

</head>


<body>
<div id="wrapper">

<!-- <div id="header"> -->
    <!-- <p class="header_titleline">忧郁的大能猫的博客</p> -->
    <!-- <p class="header_subline"><a href="/index.html">首页</a></p> -->
<!-- </div> -->



<style type="text/css">

#masthead .site-branding {
    margin-bottom: 7px;
}

#masthead .site-branding .site-title {
    font-size: 2.2rem;
    line-height: 1;
    text-transform: uppercase;
    margin: 0;
    margin-bottom: 0.5rem;
}


#masthead .site-description{
	margin:0px;
}




#masthead .site-branding .site-title a {
    display: inline-block;
    position: relative;
    top: -11px;
}

#masthead  a {
    <!-- color: #007bff; -->
    text-decoration: none;
    background-color: transparent;
}



.io-menu-desktop {
    display: block;
    text-align: right;
}
.io-menu-desktop span.io-menu-button-span {
    display: none;
}
.io-menu-desktop ul {
    padding: 0;
    margin: 0;
    list-style: none;
    background: transparent;
    display: block;
}
.io-menu-desktop ul > li {
    margin-right: -4px;
    display: inline-block;
    position: relative;
    height: 30px;
    color: #212529;
    font-size: 12px;
    text-transform: uppercase;
    text-shadow: 0 0 0 rgb(0 0 0 / 0%);
    font-weight: 400;
}
.io-menu-desktop ul > li > a {
    padding: 0;
    line-height: 29px;
    padding-left: 20px;
    padding-right: 20px;
    padding-top: 1px;
    color: #212529;
    font-size: 12px;
    text-transform: uppercase;
    text-shadow: 0 0 0 rgb(0 0 0 / 0%);
    font-weight: 400;
}
.io-menu-desktop a {
    display: block;
    -o-transition: none;
    -moz-transition: none;
    -webkit-transition: none;
    transition: none;
}
.io-menu-desktop > ul > li.current-menu-item > a, .io-menu-desktop > div > ul > li.current-menu-item > a {
    background: rgba(0, 0, 0, 0.01);
}
</style>


<header id="masthead" class="site-header row">
    <div class="site-branding col-sm-6">
        <span class="site-title" style="font-size: 2.2rem">
            <span>
                <img width="60px" height="60px"
                    src="http://www.sunxvming.com/wp-content/uploads/2019/10/QQ图片20191023170517.jpg">
            </span>


            <a href="http://www.sunxvming.com/" rel="home">忧郁的大能猫</a>
        </span>
        <p class="site-description">好奇的探索者，理性的思考者，踏实的行动者。</p>
    </div><!-- .site-branding -->

    <nav id="site-navigation" class="main-navigation col-sm-9">
        <div class="io-menu io-menu-desktop"><span class="io-menu-button io-menu-button-span">≡</span>

            <div class="menu-%e4%b8%bb%e8%8f%9c%e5%8d%95-container">
                <ul id="primary-menu" class="menu">
                    <li id="menu-item-38"
                        class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item-38">
                        <a href="http://www.sunxvming.com">首页</a></li>
                    <li id="menu-item-175"
                        class="menu-item menu-item-type-post_type menu-item-object-page menu-item-175"><a
                            href="http://www.sunxvming.com/all-articles">所有文章</a></li>
                    <li id="menu-item-176"
                        class="menu-item menu-item-type-post_type menu-item-object-page menu-item-176"><a
                            href="http://www.sunxvming.com/about">关于俺</a></li>
                </ul>
            </div>
        </div><!-- .io-menu -->
    </nav><!-- #site-navigation -->
</header>


 <!--if(title)-->

<p>Table of Contents:</p>
<div id="TOC">
<ul>
<li><a href="#测试fd泄漏"> 测试fd泄漏</a></li>
</ul>
</div>
 <!--if(toc)-->

<p>lsof(list open files)是一个列出当前系统打开文件的工具</p>
<p>常用参数</p>
<pre><code>-n    inhibits the conversion of network numbers to host names for network files. Inhibiting conversion may make lsof run faster
-c c    selects the listing of files for processes executing the command that begins with the characters of c
-p  列出pid的fd</code></pre>
<p>查看某个文件正在被谁使用</p>
<pre><code>lsof /soft/jdk1.8.0_131/bin/java</code></pre>
<p>递归查看某个目录正在使用的文件信息</p>
<pre><code>lsof +D /soft/
lsof /soft     #这样的话不会递归</code></pre>
<p>列出某个程序所打开的文件信息 </p>
<pre><code>lsof -n -c java</code></pre>
<p>查看某个进程pid打开的文件句柄</p>
<pre><code>lsof  -n -p 10339 </code></pre>
<p>ulimit -n 查看最大fd</p>
<p>CentOS 7中的lsof是按PID/TID/file的组合显示结果的,多个线程中会重复打印同一个fd 同一个进程如果多个线程访问同一个文件通常只需要打开一次、占用一个fd，但在lsof中就显示多行。 下面的命令其实也没有太大意义</p>
<pre><code>lsof -n|awk &#39;{print $2}&#39;|sort|uniq -c|sort -nr|less</code></pre>
<p>这个比较准：</p>
<pre><code>find /proc -print | grep -P &#39;/proc/\d+/fd/&#39;| awk -F &#39;/&#39; &#39;{print $3}&#39; | uniq -c | sort -rn | head</code></pre>
<p>看某个具体的进程：</p>
<pre><code>lsof -n -p &lt;pid&gt;
ls -l /proc/&lt;pid&gt;/fd | wc -l</code></pre>
<h2 id="测试fd泄漏"> 测试fd泄漏</h2>
<pre><code>#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;


int main()
{
    int pid = getpid();
    printf(&quot;pid:%d\n&quot;, pid);


    int i = 0;
    while (i &lt; 500)
    {
        int fh = open(&quot;a.txt&quot;, O_CREAT | O_WRONLY, S_IRUSR | S_IWUSR);
        printf(&quot;%d\n&quot;, fh);
        i++;
    }
    sleep(1000);
    return 0;
}</code></pre>
<p>博客：侦测程序句柄泄露的统计方法 https://www.ibm.com/developerworks/cn/linux/l-cn-handle/</p>
<p>下面脚本对某进程采样 3000 个数据，每 10 秒采样一次，依此数据绘制句柄统计趋势图。</p>
<pre><code>#!/bin/sh
set -x
echo &quot;&quot;&gt;total_handler

psid=`ps -ef|grep $1|head -1|awk &#39;{print $2}&#39;`
count=0 
while [ $count -lt 3000 ] 
do 
 lsof -p $psid|wc -l &gt;&gt; total_handler
 sleep 10 
 count=`expr $count + 1`
done</code></pre>
<p>根据我们项目的测试经验，通常统计出来的句柄图形如下列三种： 平稳 <img src="/imgs/dcacc18d-a766-4bb5-b1df-ed0161580624.png" /> 在程序运行当中，句柄被不断地打开关闭，因此统计图形呈现平稳的锯齿形。在程序运行后期，很多临时打开的句柄被逐渐关闭，总的句柄数量没有随着时间的推移而增加，因此该程序不存在句柄泄露。</p>
<p>峰值稳定 <img src="/imgs/0d46c8d1-aaaa-4725-99e9-e69af459257c.png" /> 在该程序运行初期，程序打开的句柄数量会随着时间的推移而逐步增加。但是当运行一段时间后，句柄数量会达到一个相对平稳的状态，大概 3500 左右。这个时候表明程序打开了很多临时句柄，但是句柄数量相对稳定，也不存在句柄泄露问题。</p>
<p>递增 <img src="/imgs/14960e2a-db49-4252-a2b4-12470f866e3f.png" /> 程序在运行当中，某一操作引起了程序打开句柄数量逐步增加，而且没有出现相对平稳的迹象，说明该程序可能存在句柄泄露，需要进一步分析是哪一部分的句柄存在泄漏，以及什么操作会引起程序句柄的泄露。</p>
<p>通过对程序句柄数量进行采样统计，并且绘制出相应的统计图形，能够以比较直观的方式判断在程序中是否存在句柄泄露。该方法基于程序要运行大量的测试用例，增加测试用例的覆盖率，尽可能多的用测试用例触发程序打开和关闭句柄的操作，这样才能发现潜在的句柄泄露 bug。对于如何能够快速的发现句柄泄露代码，我们将做进一步研究。</p>

<div id="footer">
    <p class="footer_titleline">忧郁的大能猫的博客</p>
    <p class="footer_subline">Contact: sunxvming@gmail.com</p>
    <p class="footer_subline">声明: 本站如有侵权行为请及时通知至以上邮箱</p>
</div>
</div> <!--wrapper-->
</body>
</html>
