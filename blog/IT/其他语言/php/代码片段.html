<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta name="generator" content="pandoc" />




<link rel="stylesheet" href="../../../.././css/style.css" type="text/css" />



<script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script>
jQuery(document).ready(function(){
    jQuery('pre').each(function(){
        var el = jQuery(this).find('code');
        var code_block = el.html(); 
 
        if (el.length > 0) { 
            jQuery(this).addClass('prettyprint').html(code_block).attr('style', 'max-height:450px');
        } else { 
            jQuery(this).removeClass().addClass('prettyprint'); 
        }
    });
});
</script>

<script type="text/javascript" src="../../run_prettify.js"></script>

</head>


<body>
<div id="wrapper">

<!-- <div id="header"> -->
    <!-- <p class="header_titleline">忧郁的大能猫的博客</p> -->
    <!-- <p class="header_subline"><a href="/index.html">首页</a></p> -->
<!-- </div> -->



<style type="text/css">

#masthead .site-branding {
    margin-bottom: 7px;
}

#masthead .site-branding .site-title {
    font-size: 2.2rem;
    line-height: 1;
    text-transform: uppercase;
    margin: 0;
    margin-bottom: 0.5rem;
}


#masthead .site-description{
	margin:0px;
}




#masthead .site-branding .site-title a {
    display: inline-block;
    position: relative;
    top: -11px;
}

#masthead  a {
    <!-- color: #007bff; -->
    text-decoration: none;
    background-color: transparent;
}



.io-menu-desktop {
    display: block;
    text-align: right;
}
.io-menu-desktop span.io-menu-button-span {
    display: none;
}
.io-menu-desktop ul {
    padding: 0;
    margin: 0;
    list-style: none;
    background: transparent;
    display: block;
}
.io-menu-desktop ul > li {
    margin-right: -4px;
    display: inline-block;
    position: relative;
    height: 30px;
    color: #212529;
    font-size: 12px;
    text-transform: uppercase;
    text-shadow: 0 0 0 rgb(0 0 0 / 0%);
    font-weight: 400;
}
.io-menu-desktop ul > li > a {
    padding: 0;
    line-height: 29px;
    padding-left: 20px;
    padding-right: 20px;
    padding-top: 1px;
    color: #212529;
    font-size: 12px;
    text-transform: uppercase;
    text-shadow: 0 0 0 rgb(0 0 0 / 0%);
    font-weight: 400;
}
.io-menu-desktop a {
    display: block;
    -o-transition: none;
    -moz-transition: none;
    -webkit-transition: none;
    transition: none;
}
.io-menu-desktop > ul > li.current-menu-item > a, .io-menu-desktop > div > ul > li.current-menu-item > a {
    background: rgba(0, 0, 0, 0.01);
}
</style>


<header id="masthead" class="site-header row">
    <div class="site-branding col-sm-6">
        <span class="site-title" style="font-size: 2.2rem">
            <span>
                <img width="60px" height="60px"
                    src="http://www.sunxvming.com/imgs/QQ图片20191023170517.jpg">
            </span>


            <a href="http://www.sunxvming.com/" rel="home">忧郁的大能猫</a>
        </span>
        <p class="site-description">好奇的探索者，理性的思考者，踏实的行动者。</p>
    </div><!-- .site-branding -->

    <nav id="site-navigation" class="main-navigation col-sm-9">
        <div class="io-menu io-menu-desktop"><span class="io-menu-button io-menu-button-span">≡</span>

            <div class="menu-%e4%b8%bb%e8%8f%9c%e5%8d%95-container">
                <ul id="primary-menu" class="menu">
                    <li id="menu-item-38"
                        class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item-38">
                        <a href="http://www.sunxvming.com">首页</a></li>
                    <li id="menu-item-175"
                        class="menu-item menu-item-type-post_type menu-item-object-page menu-item-175"><a
                            href="http://www.sunxvming.com/all-articles">所有文章</a></li>
                    <li id="menu-item-176"
                        class="menu-item menu-item-type-post_type menu-item-object-page menu-item-176"><a
                            href="http://www.sunxvming.com/about">关于俺</a></li>
                </ul>
            </div>
        </div><!-- .io-menu -->
    </nav><!-- #site-navigation -->
</header>


 <!--if(title)-->

<p>Table of Contents:</p>
<div id="TOC">
<ul>
<li><a href="#php-ssh2">php ssh2</a></li>
<li><a href="#文件锁">文件锁</a></li>
<li><a href="#crul运用">crul运用</a></li>
<li><a href="#生成数字签名">生成数字签名</a></li>
<li><a href="#验证数字签名">验证数字签名</a></li>
<li><a href="#php通过header函数下载文件">php通过header函数下载文件</a></li>
<li><a href="#查看邮件是否已被阅读">查看邮件是否已被阅读</a></li>
<li><a href="#查找页面上的所有链接">查找页面上的所有链接</a></li>
<li><a href="#从服务器上下载保存一个远程图片">从服务器上下载&amp;保存一个远程图片</a></li>
</ul>
</div>
 <!--if(toc)-->

<h3 id="php-ssh2">php ssh2</h3>
<p>下载 php extension ssh2 并进行配置</p>
<pre><code>$connection = ssh2_connect(&quot;hangge.oicp.net&quot;,8022);
if(ssh2_auth_password($connection,&quot;root&quot;,&quot;yuhang&quot;)){
    echo &quot;Successfull&quot;;
}else{
    die(&quot;Failed&quot;);
}
 
$tcmd = &#39;/usr/bin/etherwake -D &quot;1c:6f:65:20:70:d4&quot;&#39;;
$stream = ssh2_exec($connection,$tcmd);
stream_set_blocking($stream,true);
echo stream_get_contents($stream);</code></pre>
<pre><code>$connection = ssh2_connect(&#39;10.1.10.81&#39;, 22);
if (!$connection) {
        exit();
}
if (!ssh2_auth_password($connection, &#39;root&#39;, &#39;123456&#39;)) {
        exit();
}


$cmd = &quot;mysqldump worktime &gt; /data/worktime.sql&quot;;
$stream = ssh2_exec($connection, $cmd);
stream_set_blocking($stream, true);
 
stream_get_contents($stream);
 
ssh2_scp_recv($connection, &quot;/data/worktime.sql&quot;, &quot;/home/worktime.sql&quot;);</code></pre>
<h3 id="文件锁">文件锁</h3>
<pre><code>$fp = fopen(&#39;a.lock&#39;,&#39;r&#39;);
$try = 10;
do{
    $lock = flock($fp, LOCK_EX);
    if(!$lock)
        usleep(50000);
}while(!$lock &amp;&amp; --try &gt;0);


if($lock){
    //执行要做的逻辑
    //执行完后
    flock($pf,LOCK_UN);
    fclose($fp);
}else{
    fclose($fp);
    die(&#39;系统繁忙，稍后再试&#39;);
}</code></pre>
<pre><code>&lt;?php
class Locker
{
 private static $_lockFp = array();
 public static function startLock($lockFileName)
 {
  self::$_lockFp[$lockFileName] = $fp = fopen(ROOT . &#39;/data/lock/&#39;.$lockFileName, &#39;r&#39;);
  if(!$fp)
   return FALSE;
  $try = 10;
  $lock = false;
  do 
  {
   $lock = flock($fp, LOCK_EX);
   if(!$lock)
    usleep(50000); // 0.05秒
  }while(!$lock &amp;&amp; --$try &gt; 0);
  return $lock;
 }
 public static function endLock($lockFileName)
 {
  if(isset(self::$_lockFp[$lockFileName]))
  {
   @flock(self::$_lockFp[$lockFileName], LOCK_UN);
   @fclose(self::$_lockFp[$lockFileName]);
  }
 }
}</code></pre>
<h3 id="crul运用">crul运用</h3>
<pre><code>   function GetCurl($url) {
        $curl = curl_init();
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl, CURLOPT_URL, $url);
        curl_setopt($curl, CURLOPT_USERAGENT, $_SERVER[&#39;HTTP_USER_AGENT&#39;]);
        $resp = curl_exec($curl);
        curl_close($curl);
        return $resp;
    }
 
    echo(GetCurl(&#39;http://e.wesambo.com/index.php?c=index&amp;a=getip&#39;));</code></pre>
<h3 id="生成数字签名">生成数字签名</h3>
<pre><code>&lt;?php
//error_reporting(0);
 
$m = $_GET[&#39;m&#39;];
$t = $_GET[&#39;t&#39;];
 
if (md5(&#39;yy_zz_fancy3d&#39;) != $m) {
    echo &#39;&#39;;
    //exit();
}
 


if (strlen($t) &lt; 8) {
    $t = sprintf(&#39;%08s&#39;,$t);
}
 
$prikey = &lt;&lt;&lt;EOD
-----BEGIN RSA PRIVATE KEY-----
MIICXAIBAAKBgQCW9ZXCaUo7MPKF8mnJahuocseVaHlFIJmvWbjtT58gisfx3y5Z
d3q+A8BGcuy5KcWY+zQ6AKjcEGTasHzo7gshUMQDyaFnruJTDC7AjnH91pMX2H/g
jH+1Y2TZPZXyRHZBoHUzR2Z8ubLXU3T5zjZCnm+vKFatPI+L/+6TzqLXIQIDAQAB
AoGAesPz66vWy3ZN9PKkZ0Fchsv5VZ8l6DrP4ROVWaDD5yIV4rS+q9GHx1mjl2dE
7nxzDqtT2MvKh1TpwBOBMajM8SZD4Hx4nTzvrUod/6qdppTC2uTIXBYxJqGemaUt
yJ1OBetwpD6MKR1d1JzIdm4PgV3mfZc9Sub5Phhiwgwl4AECQQDIALoXFue69sbT
6K8X0jK9EM92AwcIc7nLAIsDF+cvsfJzb3YVT1/1cwkWGd36dd10AeFPWmG1hnUw
7Pxmp5AhAkEAwTmlgWhpklx7LwCDWJQFA/lH2nGCgHtMqn/BSEaTeq36UHGgedqh
lYrgReQVJK6j5jpamCk/iE2JD6AWdT5nAQJBAKfiFFL1YydJprSSiQdR5k1WIw9I
k0rA+aAxoH7EPceHc6D6WwCgVEhQe7wVkoN/FJkgSuS1VXdumkirZWM2HIECQFs9
PzuF9CPaa4hcM6lF68Bem2E4rCjDEAaKYNgiC02ojUQjA2XGqPoWI6Sc+KbjmB0E
fPbQs2FHS2sHatNd7gECQFPWDR10stjyRJjuG8loOxtNcZq1m3KnsdnnPDQiAc6K
R20c0rz6Nr5KFwjzFo/SmW2BYtbEtIXyMah6KcVA2vA=
-----END RSA PRIVATE KEY-----
EOD;
 
$priv_key_id = openssl_get_privatekey($prikey);
 
$sign;
 
$ret = openssl_sign($t,$sign,$prikey,OPENSSL_ALGO_SHA1);
 
echo base64_encode($sign);</code></pre>
<h3 id="验证数字签名">验证数字签名</h3>
<pre><code>&lt;?php
 
$data = &quot;00012345&quot;;
 
$private_key = &lt;&lt;&lt;EOD
-----BEGIN RSA PRIVATE KEY-----
MIICXAIBAAKBgQCW9ZXCaUo7MPKF8mnJahuocseVaHlFIJmvWbjtT58gisfx3y5Z
d3q+A8BGcuy5KcWY+zQ6AKjcEGTasHzo7gshUMQDyaFnruJTDC7AjnH91pMX2H/g
jH+1Y2TZPZXyRHZBoHUzR2Z8ubLXU3T5zjZCnm+vKFatPI+L/+6TzqLXIQIDAQAB
AoGAesPz66vWy3ZN9PKkZ0Fchsv5VZ8l6DrP4ROVWaDD5yIV4rS+q9GHx1mjl2dE
7nxzDqtT2MvKh1TpwBOBMajM8SZD4Hx4nTzvrUod/6qdppTC2uTIXBYxJqGemaUt
yJ1OBetwpD6MKR1d1JzIdm4PgV3mfZc9Sub5Phhiwgwl4AECQQDIALoXFue69sbT
6K8X0jK9EM92AwcIc7nLAIsDF+cvsfJzb3YVT1/1cwkWGd36dd10AeFPWmG1hnUw
7Pxmp5AhAkEAwTmlgWhpklx7LwCDWJQFA/lH2nGCgHtMqn/BSEaTeq36UHGgedqh
lYrgReQVJK6j5jpamCk/iE2JD6AWdT5nAQJBAKfiFFL1YydJprSSiQdR5k1WIw9I
k0rA+aAxoH7EPceHc6D6WwCgVEhQe7wVkoN/FJkgSuS1VXdumkirZWM2HIECQFs9
PzuF9CPaa4hcM6lF68Bem2E4rCjDEAaKYNgiC02ojUQjA2XGqPoWI6Sc+KbjmB0E
fPbQs2FHS2sHatNd7gECQFPWDR10stjyRJjuG8loOxtNcZq1m3KnsdnnPDQiAc6K
R20c0rz6Nr5KFwjzFo/SmW2BYtbEtIXyMah6KcVA2vA=
-----END RSA PRIVATE KEY-----
EOD;
$public_key = &lt;&lt;&lt;EOD
-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCW9ZXCaUo7MPKF8mnJahuocseV
aHlFIJmvWbjtT58gisfx3y5Zd3q+A8BGcuy5KcWY+zQ6AKjcEGTasHzo7gshUMQD
yaFnruJTDC7AjnH91pMX2H/gjH+1Y2TZPZXyRHZBoHUzR2Z8ubLXU3T5zjZCnm+v
KFatPI+L/+6TzqLXIQIDAQAB
-----END PUBLIC KEY-----
EOD;
 
$binary_signature = &quot;&quot;;
 
 
openssl_sign($data, $binary_signature, $private_key, OPENSSL_ALGO_SHA1);
 
// Check signature
$ok = openssl_verify($data, $binary_signature, $public_key, OPENSSL_ALGO_SHA1);
echo &quot;check #1: &quot;;
if ($ok == 1) {
    echo &quot;signature ok (as it should be)\n&quot;;
} elseif ($ok == 0) {
    echo &quot;bad (there&#39;s something wrong)\n&quot;;
} else {
    echo &quot;ugly, error checking signature\n&quot;;
}</code></pre>
<h3 id="php通过header函数下载文件">php通过header函数下载文件</h3>
<p>般来说, 我们可以通过直接让URL指向一个位于Document Root下面的文件, 来引导用户下载文件. 但是, 这样做, 就没办法做一些统计, 权限检查, 等等的工作. 于是, 很多时候, 我们采用让PHP来做转发, 为用户提供文件下载.</p>
<pre><code>&lt;?php
    $file = &quot;/tmp/dummy.tar.gz&quot;;
    header(&quot;Content-type: application/octet-stream&quot;);
    header(&#39;Content-Disposition: attachment; filename=&quot;&#39; . basename($file) . &#39;&quot;&#39;);
    header(&quot;Content-Length: &quot;. filesize($file));
    readfile($file);</code></pre>
<h3 id="查看邮件是否已被阅读">查看邮件是否已被阅读</h3>
<p>高明之处在于在图片中隐藏东西</p>
<pre><code>&lt;?php
error_reporting(0);
//Get IP
if (!empty($_SERVER[&#39;HTTP_CLIENT_IP&#39;]))
{
  $ip=$_SERVER[&#39;HTTP_CLIENT_IP&#39;];
}
elseif (!empty($_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;]))
{
  $ip=$_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;];
}
else
{
  $ip=$_SERVER[&#39;REMOTE_ADDR&#39;];
}


//Time
$actual_time = time();
$actual_day = date(&#39;Y.m.d&#39;, $actual_time);
$actual_day_chart = date(&#39;d/m/y&#39;, $actual_time);
$actual_hour = date(&#39;H:i:s&#39;, $actual_time);


//GET Browser
$browser = $_SERVER[&#39;HTTP_USER_AGENT&#39;];


//LOG
$myFile = &quot;log.txt&quot;;
$fh = fopen($myFile, &#39;a+&#39;);
$stringData = $actual_day . &#39; &#39; . $actual_hour . &#39; &#39; . $ip . &#39; &#39; . $browser . &#39; &#39; . &quot;\r\n&quot;;
fwrite($fh, $stringData);
fclose($fh);


// Set the content type header - in this case image/jpeg
header(&#39;Content-Type: image/jpeg&#39;);
$newimage = ImageCreate(1,1);
$grigio = ImageColorAllocate($newimage,255,0,0);
ImageJPEG($newimage);
ImageDestroy($newimage);</code></pre>
<h3 id="查找页面上的所有链接">查找页面上的所有链接</h3>
<p>高明之处在于用dom来找</p>
<pre><code>&lt;?php
$html = file_get_contents(&#39;http://www.zhihu.com&#39;);


$dom = new DOMDocument();
@$dom-&gt;loadHTML($html);


// grab all the on the page
$xpath = new DOMXPath($dom);
$hrefs = $xpath-&gt;evaluate(&quot;/html/body//a&quot;);


for ($i = 0; $i &lt; $hrefs-&gt;length; $i++) {
       $href = $hrefs-&gt;item($i);
       $url = $href-&gt;getAttribute(&#39;href&#39;);
       echo $url.&#39;&lt;br /&gt;&#39;;
}</code></pre>
<h3 id="从服务器上下载保存一个远程图片">从服务器上下载&amp;保存一个远程图片</h3>
<pre><code>$image = file_get_contents(&#39;http://www.url.com/image.jpg&#39;);
file_put_contents(&#39;/images/image.jpg&#39;, $image); //Where to save the image</code></pre>

<div id="footer">
    <p class="footer_titleline">忧郁的大能猫的博客</p>
    <p class="footer_subline">Contact: sunxvming@gmail.com</p>
    <p class="footer_subline">声明: 本站如有侵权行为请及时通知至以上邮箱</p>
</div>
</div> <!--wrapper-->
</body>
</html>
