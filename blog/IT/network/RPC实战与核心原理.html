<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta name="generator" content="pandoc" />




<link rel="stylesheet" href="../../.././css/style.css" />




<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Saira+Semi+Condensed%3A400%2C700&ver=4.9.18" type="text/css" />

<script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script>
jQuery(document).ready(function(){
    jQuery('pre').each(function(){
        var el = jQuery(this).find('code');
        var code_block = el.html(); 
 
        if (el.length > 0) { 
            jQuery(this).addClass('prettyprint').html(code_block).attr('style', 'max-height:450px');
        } else { 
            jQuery(this).removeClass().addClass('prettyprint'); 
        }
    });
});
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?skin=desert"></script>

</head>


<body>
<div id="wrapper">


<style type="text/css">

#masthead .site-branding {
    margin-bottom: 7px;
}

#masthead .site-branding .site-title {
    font-size: 2.2rem;
    line-height: 1;
    text-transform: uppercase;
    margin: 0;
    margin-bottom: 0.5rem;
}


#masthead .site-description{
	margin:0px;
}




#masthead .site-branding .site-title a {
    display: inline-block;
    position: relative;
    top: -11px;
}

#masthead  a {
    <!-- color: #007bff; -->
    text-decoration: none;
    background-color: transparent;
}



.io-menu-desktop {
    display: block;
    text-align: right;
}
.io-menu-desktop span.io-menu-button-span {
    display: none;
}
.io-menu-desktop ul {
    padding: 0;
    margin: 0;
    list-style: none;
    background: transparent;
    display: block;
}
.io-menu-desktop ul > li {
    margin-right: -4px;
    display: inline-block;
    position: relative;
    height: 30px;
    color: #212529;
    font-size: 12px;
    text-transform: uppercase;
    text-shadow: 0 0 0 rgb(0 0 0 / 0%);
    font-weight: 400;
}
.io-menu-desktop ul > li > a {
    padding: 0;
    line-height: 29px;
    padding-left: 20px;
    padding-right: 20px;
    padding-top: 1px;
    color: #212529;
    font-size: 12px;
    text-transform: uppercase;
    text-shadow: 0 0 0 rgb(0 0 0 / 0%);
    font-weight: 400;
}
.io-menu-desktop a {
    display: block;
    -o-transition: none;
    -moz-transition: none;
    -webkit-transition: none;
    transition: none;
}
.io-menu-desktop > ul > li.current-menu-item > a, .io-menu-desktop > div > ul > li.current-menu-item > a {
    background: rgba(0, 0, 0, 0.01);
}



#colophon {
    margin-top: 70px;
    margin-bottom: 30px;
}
#colophon .site-info {
    text-align: center;
}

</style>


<header id="masthead" class="site-header row">
    <div class="site-branding col-sm-6">
        <span class="site-title" style="font-size: 2.2rem">
            <span>
                <img width="60px" height="60px"
                    src="http://www.sunxvming.com/imgs/QQ图片20191023170517.jpg">
            </span>


            <a href="http://www.sunxvming.com/" rel="home">忧郁的大能猫</a>
        </span>
        <p class="site-description">好奇的探索者，理性的思考者，踏实的行动者。</p>
    </div><!-- .site-branding -->

    <nav id="site-navigation" class="main-navigation col-sm-9">
        <div class="io-menu io-menu-desktop"><span class="io-menu-button io-menu-button-span">≡</span>

            <div class="menu-%e4%b8%bb%e8%8f%9c%e5%8d%95-container">
                <ul id="primary-menu" class="menu">
                    <li id="menu-item-38"
                        class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item-38">
                        <a href="http://www.sunxvming.com">首页</a></li>
                    <li id="menu-item-175"
                        class="menu-item menu-item-type-post_type menu-item-object-page menu-item-175"><a
                            href="http://www.sunxvming.com/">所有文章</a></li>
                    <li id="menu-item-176"
                        class="menu-item menu-item-type-post_type menu-item-object-page menu-item-176"><a
                            href="http://www.sunxvming.com/blog/about-me.html">关于俺</a></li>
                </ul>
            </div>
        </div><!-- .io-menu -->
    </nav><!-- #site-navigation -->
</header>

<div id="header">
<h1 class="title">blog/IT/network/RPC实战与核心原理</h1>
</div> <!--id="header"-->
 <!--if(title)-->

<p>Table of Contents:</p>
<div id="TOC">
<ul>
<li><a href="#开篇词-别老想着怎么用好rpc框架你得多花时间琢磨原理">开篇词 | 别老想着怎么用好RPC框架，你得多花时间琢磨原理</a></li>
<li><a href="#核心原理能否画张图解释下rpc的通信流程">01 | 核心原理：能否画张图解释下RPC的通信流程？</a></li>
<li><a href="#协议怎么设计可扩展且向后兼容的协议">02 | 协议：怎么设计可扩展且向后兼容的协议？</a>
<ul>
<li><a href="#那怎么设计一个私有-rpc-协议呢">那怎么设计一个私有 RPC 协议呢？</a></li>
</ul></li>
<li><a href="#序列化对象怎么在网络中传输">03 | 序列化：对象怎么在网络中传输？</a>
<ul>
<li><a href="#有哪些常用的序列化">有哪些常用的序列化？</a></li>
<li><a href="#rpc-框架中如何选择序列化">RPC 框架中如何选择序列化？</a></li>
</ul></li>
<li><a href="#网络通信rpc框架在网络通信上更倾向于哪种网络io模型">04 | 网络通信：RPC框架在网络通信上更倾向于哪种网络IO模型？</a>
<ul>
<li><a href="#常见的网络-io-模型">常见的网络 IO 模型</a></li>
<li><a href="#什么是零拷贝">什么是零拷贝？</a></li>
</ul></li>
<li><a href="#动态代理面向接口编程屏蔽rpc处理流程">05 | 动态代理：面向接口编程，屏蔽RPC处理流程</a></li>
<li><a href="#rpc实战剖析grpc源码动手实现一个完整的rpc">06 | RPC实战：剖析gRPC源码，动手实现一个完整的RPC</a></li>
</ul>
</div>
 <!--if(toc)-->

<h2 id="开篇词-别老想着怎么用好rpc框架你得多花时间琢磨原理">开篇词 | 别老想着怎么用好RPC框架，你得多花时间琢磨原理</h2>
<p>只要涉及到网络通信，我们就可能用到 RPC<br />
在我看来，RPC 是解决分布式系统通信问题的一大利器。<br />
这个系列的文章是有java代码讲解的。</p>
<h2 id="核心原理能否画张图解释下rpc的通信流程">01 | 核心原理：能否画张图解释下RPC的通信流程？</h2>
<p>我理解的 RPC 是帮助我们屏蔽网络编程细节，实现调用远程方法就跟调用本地（同一个项<br />
目中的方法）一样的体验，我们不需要因为这个方法是远程调用就需要编写很多与业务无关 的代码。<br />
我认为，RPC 的作用就是体现在这样两个方面：<br />
屏蔽远程调用跟本地调用的区别，让我们感觉就是调用项目内的方法；<br />
隐藏底层网络通信的复杂性，让我们更专注于业务逻辑</p>
<p>围绕 RPC 我们讲了这么多，那 RPC 在架构中究竟处于什么位置呢？<br />
如刚才所讲，RPC 是解决应用间通信的一种方式，而无论是在一个大型的分布式应用系统<br />
还是中小型系统中，应用架构最终都会从“单体”演进成“微服务化”，整个应用系统会被<br />
拆分为多个不同功能的应用，并将它们部署在不同的服务器中，而应用之间会通过 RPC 进<br />
行通信，可以说 RPC 对应的是整个分布式应用系统，就像是“经络”一样的存在。</p>
<p>RPC 框架能够帮助我们解决系统拆分后的通信问题，并且能让我们像调用本地一样去调用<br />
远程方法。利用 RPC 我们不仅可以很方便地将应用架构从“单体”演进成“微服务化”，<br />
而且还能解决实际开发过程中的效率低下、系统耦合等问题，这样可以使得我们的系统架构<br />
整体清晰、健壮，应用可运维度增强。</p>
<p>适用场景：和服务器的交互比较多的情况</p>
<h2 id="协议怎么设计可扩展且向后兼容的协议">02 | 协议：怎么设计可扩展且向后兼容的协议？</h2>
<p>这还要从 RPC 的作用说起，相对于 HTTP 的用处，RPC 更多的是负责应用间的通信，所以 性能要求相对更高。</p>
<h3 id="那怎么设计一个私有-rpc-协议呢">那怎么设计一个私有 RPC 协议呢？</h3>
<p>在协议头里面，我们除了会放协议长度、序列化方式，还会放一些像协议标示、消息 ID、<br />
消息类型这样的参数，而协议体一般只放请求接口方法、请求的业务参数值和一些扩展属<br />
性。这样一个完整的 RPC 协议大概就出来了，协议头是由一堆固定的长度参数组成，而协<br />
议体是根据请求接口和参数构造的，长度属于可变的，具体协议如下图所示：</p>
<p>可扩展的协议：<br />
刚才讲的协议属于定长协议头，那也就是说往后就不能再往协议头里加新参数了，如果加参<br />
数就会导致线上兼容问题。<br />
决绝方法就是消息头也是长度可变。</p>
<p>设计一个简单的 RPC 协议并不难，难的就是怎么去设计一个可“升级”的<br />
协议。不仅要让我们在扩展新特性的时候能做到向下兼容，而且要尽可能地减少资源损耗，<br />
所以我们协议的结构不仅要支持协议体的扩展，还要做到协议头也能扩展。</p>
<h2 id="序列化对象怎么在网络中传输">03 | 序列化：对象怎么在网络中传输？</h2>
<h3 id="有哪些常用的序列化">有哪些常用的序列化？</h3>
<ul>
<li>JDK 原生序列化<br />
实际上任何一种序列化框架，核心思想就是设计一种序列化协议，将对象的类型、属性类<br />
型、属性值一一按照固定的格式写到二进制字节流中来完成序列化，再按照固定的格式一一<br />
读出对象的类型、属性类型、属性值，通过这些信息重新创建出一个新的对象，来完成反序 列化。</li>
<li>JSON<br />
JSON 进行序列化的额外空间开销比较大，对于大数据量服务这意味着需要巨大的内存<br />
和磁盘开销；<br />
JSON 没有类型，但像 Java 这种强类型语言，需要通过反射统一解决，所以性能不会太<br />
好</li>
<li>Protobuf</li>
</ul>
<h3 id="rpc-框架中如何选择序列化">RPC 框架中如何选择序列化？</h3>
<p>序列化与反序列化过程是 RPC 调用的一个必须过程，那么序列化与反序列化的性能、效率、和序列化后的大小<br />
势必将直接关系到 RPC 框架整体的性能和效率。</p>
<h2 id="网络通信rpc框架在网络通信上更倾向于哪种网络io模型">04 | 网络通信：RPC框架在网络通信上更倾向于哪种网络IO模型？</h2>
<h3 id="常见的网络-io-模型">常见的网络 IO 模型</h3>
<p>那说到网络通信，就不得不提一下网络 IO 模型。为什么要讲网络 IO 模型呢？因为所谓的<br />
两台 PC 机之间的网络通信，实际上就是两台 PC 机对网络 IO 的操作。<br />
常见的网络 IO 模型分为四种：同步阻塞 IO（BIO）、同步非阻塞 IO（NIO）、IO 多路复<br />
用和异步非阻塞 IO（AIO）。在这四种 IO 模型中，只有 AIO 为异步 IO，其他都是同步 IO</p>
<p>RPC 调用在大多数的情况下，是一个高并发调用的场景，考虑到系统内核的支持、编程语<br />
言的支持以及 IO 模型本身的特点，在 RPC 框架的实现中，在网络通信的处理上，我们会<br />
选择 IO 多路复用的方式。开发语言的网络通信框架的选型上，我们最优的选择是基于<br />
Reactor 模式实现的框架，如 Java 语言，首选的框架便是 Netty 框架（Java 还有很多其<br />
他 NIO 框架，但目前 Netty 应用得最为广泛），并且在 Linux 环境下，也要开启 epoll 来<br />
提升系统性能（Windows 环境下是无法开启 epoll 的，因为系统内核不支持）。</p>
<h3 id="什么是零拷贝">什么是零拷贝？</h3>
<p>应用进程的每一次写操作，都会把数据写到用户空间的缓冲区中，再由 CPU 将数据拷贝到<br />
系统内核的缓冲区中，之后再由 DMA 将这份数据拷贝到网卡中，最后由网卡发送出去。<br />
这里我们可以看到，一次写操作数据要拷贝两次才能通过网卡发送出去，而用户进程的读操<br />
作则是将整个流程反过来，数据同样会拷贝两次才能让应用程序读取到数据。</p>
<p>那怎么做到零拷贝？你想一下是不是用户空间与内核空间都将数据写到一个地方，就不需要<br />
拷贝了？此时你有没有想到虚拟内存？<br />
零拷贝有两种解决方式，分别是 mmap+write 方式和 sendfile 方式，其核心原理都是<br />
通过虚拟内存来解决的。</p>
<h2 id="动态代理面向接口编程屏蔽rpc处理流程">05 | 动态代理：面向接口编程，屏蔽RPC处理流程</h2>
<h2 id="rpc实战剖析grpc源码动手实现一个完整的rpc">06 | RPC实战：剖析gRPC源码，动手实现一个完整的RPC</h2>

<footer id="colophon" >
		<div class="site-info col">
			Powered by <a href="https://github.com/sunxvming/my-blog">my-blog</a>
			<span class="sep"> | </span>
				<span><a target="_blank" href="http://beian.miit.gov.cn">【京ICP备19018538号】</a></span>
			<span><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502037753">【京公网安备 11010502037753号】</a></span>
		</div><!-- .site-info col -->
        <div class="site-info col"> This page is hosted at <a target="_blank" href="https://github.com/sunxvming">Github</a>.To see the source code you can visit the <a target="_blank" href="https://github.com/sunxvming/my-blog">repo</a> and I'd be glad if you like and star it.</div>
</footer>
</div> <!--wrapper-->
</body>
</html>
