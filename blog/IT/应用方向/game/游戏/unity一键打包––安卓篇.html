<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta name="generator" content="pandoc" />




<link rel="stylesheet" href="../../../../.././css/style.css" />




<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Saira+Semi+Condensed%3A400%2C700&ver=4.9.18" type="text/css" />

<script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script>
jQuery(document).ready(function(){
    jQuery('pre').each(function(){
        var el = jQuery(this).find('code');
        var code_block = el.html(); 
 
        if (el.length > 0) { 
            jQuery(this).addClass('prettyprint').html(code_block).attr('style', 'max-height:450px');
        } else { 
            jQuery(this).removeClass().addClass('prettyprint'); 
        }
    });
});
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?skin=desert"></script>

</head>


<body>
<div id="wrapper">


<style type="text/css">

#masthead .site-branding {
    margin-bottom: 7px;
}

#masthead .site-branding .site-title {
    font-size: 2.2rem;
    line-height: 1;
    text-transform: uppercase;
    margin: 0;
    margin-bottom: 0.5rem;
}


#masthead .site-description{
	margin:0px;
}




#masthead .site-branding .site-title a {
    display: inline-block;
    position: relative;
    top: -11px;
}

#masthead  a {
    <!-- color: #007bff; -->
    text-decoration: none;
    background-color: transparent;
}



.io-menu-desktop {
    display: block;
    text-align: right;
}
.io-menu-desktop span.io-menu-button-span {
    display: none;
}
.io-menu-desktop ul {
    padding: 0;
    margin: 0;
    list-style: none;
    background: transparent;
    display: block;
}
.io-menu-desktop ul > li {
    margin-right: -4px;
    display: inline-block;
    position: relative;
    height: 30px;
    color: #212529;
    font-size: 12px;
    text-transform: uppercase;
    text-shadow: 0 0 0 rgb(0 0 0 / 0%);
    font-weight: 400;
}
.io-menu-desktop ul > li > a {
    padding: 0;
    line-height: 29px;
    padding-left: 20px;
    padding-right: 20px;
    padding-top: 1px;
    color: #212529;
    font-size: 12px;
    text-transform: uppercase;
    text-shadow: 0 0 0 rgb(0 0 0 / 0%);
    font-weight: 400;
}
.io-menu-desktop a {
    display: block;
    -o-transition: none;
    -moz-transition: none;
    -webkit-transition: none;
    transition: none;
}
.io-menu-desktop > ul > li.current-menu-item > a, .io-menu-desktop > div > ul > li.current-menu-item > a {
    background: rgba(0, 0, 0, 0.01);
}



#colophon {
    margin-top: 70px;
    margin-bottom: 30px;
}
#colophon .site-info {
    text-align: center;
}

</style>


<header id="masthead" class="site-header row">
    <div class="site-branding col-sm-6">
        <span class="site-title" style="font-size: 2.2rem">
            <span>
                <img width="60px" height="60px"
                    src="http://www.sunxvming.com/imgs/QQ图片20191023170517.jpg">
            </span>


            <a href="http://www.sunxvming.com/" rel="home">忧郁的大能猫</a>
        </span>
        <p class="site-description">好奇的探索者，理性的思考者，踏实的行动者。</p>
    </div><!-- .site-branding -->

    <nav id="site-navigation" class="main-navigation col-sm-9">
        <div class="io-menu io-menu-desktop"><span class="io-menu-button io-menu-button-span">≡</span>

            <div class="menu-%e4%b8%bb%e8%8f%9c%e5%8d%95-container">
                <ul id="primary-menu" class="menu">
                    <li id="menu-item-38"
                        class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item-38">
                        <a href="http://www.sunxvming.com">首页</a></li>
                    <li id="menu-item-175"
                        class="menu-item menu-item-type-post_type menu-item-object-page menu-item-175"><a
                            href="http://www.sunxvming.com/">所有文章</a></li>
                    <li id="menu-item-176"
                        class="menu-item menu-item-type-post_type menu-item-object-page menu-item-176"><a
                            href="http://www.sunxvming.com/blog/about-me.html">关于俺</a></li>
                </ul>
            </div>
        </div><!-- .io-menu -->
    </nav><!-- #site-navigation -->
</header>

<div id="header">
<h1 class="title">blog/IT/应用方向/game/游戏/unity一键打包––安卓篇</h1>
</div> <!--id="header"-->
 <!--if(title)-->

<p>Table of Contents:</p>
<div id="TOC">
<ul>
<li><a href="#一依赖环境"> 一：依赖环境</a>
<ul>
<li><a href="#一台做版机"> 1.一台做版机</a></li>
<li><a href="#安装jdk1.8"> 2.安装jdk1.8</a></li>
<li><a href="#安装andriod-sdk"> 3.安装andriod SDK</a></li>
<li><a href="#设置unity"> 4.设置unity</a></li>
</ul></li>
<li><a href="#二andriod-studio的基本使用"> 二：andriod studio的基本使用</a>
<ul>
<li><a href="#什么时候需要andriod-studio"> 1.什么时候需要andriod studio</a></li>
<li><a href="#常用工具"> 2.常用工具</a></li>
<li><a href="#安卓编译和生成.class文件"> 3.安卓编译和生成.class文件</a></li>
<li><a href="#安卓包解压后的目录结构"> 4.安卓包解压后的目录结构</a></li>
<li><a href="#android资源文件"> 5.android资源文件</a></li>
<li><a href="#android工程作为插件导入untiy"> 6.android工程作为插件导入untiy</a></li>
<li><a href="#studio-gradle构建工具报错"> 7.studio gradle构建工具报错</a></li>
</ul></li>
<li><a href="#三打包时可能会遇到问题"> 三：打包时可能会遇到问题</a>
<ul>
<li><a href="#tools版本太高"> 1.tools版本太高</a></li>
</ul></li>
<li><a href="#四如何一键打包"> 四：如何一键打包</a>
<ul>
<li><a href="#apk自动打包脚本"> 1.apk自动打包脚本</a></li>
<li><a href="#ab包自动打包脚本"> 2.ab包自动打包脚本</a></li>
</ul></li>
<li><a href="#五如何真机调试"> 五：如何真机调试</a></li>
</ul>
</div>
 <!--if(toc)-->

<blockquote>
<p> 本文记录了unity打安卓包的相关知识点，以及我的之前的一个mmo游戏项目中的打包脚本，项目所用的unity版本为5.6.6f2</p>
</blockquote>
<p>打包的原则：<br />
1.越早越好。打包的功能要越早越好，因为越往后游戏工程里的资源就越多。一是打包速度慢，二调试更加麻烦<br />
2.定时打包。打包的功能完成后，要定期进行打包，比如每天晚上打一个包，这样可以及时发现打包的问题，同时可以发现游戏中的问题</p>
<h2 id="一依赖环境"> 一：依赖环境</h2>
<h3 id="一台做版机"> 1.一台做版机</h3>
<p>专门打游戏安装包的电脑，配置要高，i7处理器 + 独立显卡 + ssd硬盘<br />
你要弄个低配的电脑打个一两个G的资源，起码得个一俩小时的。<br />
那打个包为啥还得要好显卡呀，因为打包的时候处理资源很多操作是在显卡上进行的。</p>
<h3 id="安装jdk1.8"> 2.安装jdk1.8</h3>
<p>jdk1.9有坑，可能会缺少rt.jay的jay包,而发生错误。<br />
设置环境变量</p>
<pre><code>JAVA_HOME D:\Program Files(x86)\Java\jdk1.8.0_144
CLASSPATH %JAVA_HOME%\jre\lib\rt.jay;
Path %JAVA_HOME%\bin</code></pre>
<h3 id="安装andriod-sdk"> 3.安装andriod SDK</h3>
<p>单独下载andriod sdk没的地方没发现，于是下载了andriod studio, 这里面就包含着andriod SDK<br />
设置环境变量</p>
<pre><code>ANDROID_SDK_HOME D:\Android\sdk
Path %ANDROID_SDK_HOME%\platform-tools;%ANDROID_SDK_HOME%\tools</code></pre>
<h3 id="设置unity"> 4.设置unity</h3>
<p><img src="http://www.sunxvming.com/imgs/c144cc20-32ab-48e0-a809-aaf6daa61155.png" /></p>
<h2 id="二andriod-studio的基本使用"> 二：andriod studio的基本使用</h2>
<h3 id="什么时候需要andriod-studio"> 1.什么时候需要andriod studio</h3>
<p>i.有些功能在unity层是实现不了的，比如：。需要修改安卓的MainActivity文件，这时就需要用andriod studio生成.class，然后放到Assets\Plugins\Android\bin目录下<br />
ii.调试安卓包的时候也会用到andriod studio</p>
<h3 id="常用工具"> 2.常用工具</h3>
<p><img src="http://www.sunxvming.com/imgs/973e8690-04f9-45a4-8cd8-0fe18caac0f6.png" /><br />
<em> Android SDK Manager<br />
主要是下载和管理sdk的<br />
</em> AVD(Android Virtual Device) Manager<br />
管理模拟器的，创建一个，然后点这里的运行就可以出来一个andriod模拟器了<br />
<img src="http://www.sunxvming.com/imgs/bb3058b1-4db9-454b-9afd-08d2439e473a.png" /><br />
* 模拟器添加APK文件的方法<br />
1.将要安装的apk文件放在sdk文件的platform-tools文件下 例：D:\Android\Sdk\platform-tools<br />
2.命令行下，在Android\Sdk\platform-tools 目录下执行</p>
<pre><code>adb install xxx.apk //出现success就添加成功了。</code></pre>
<p>* android device monitor<br />
监控模拟器信息的<br />
<img src="http://www.sunxvming.com/imgs/52b1d9bc-dfa8-42e8-a334-c963c60fd596.png" /><br />
文件管理显示空白：参考网上的替换了monitor中的ddmlib.jar这个包后就好了<br />
data目录下空白：是因为没有权限，执行如下命令即可：<br />
 adb shell<br />
 su root<br />
 chmod 777 /data<br />
 </p>
<h3 id="安卓编译和生成.class文件"> 3.安卓编译和生成.class文件</h3>
<p>编译后的.class文件是放在项目的build目录下，intermediates\classes\debug\com\example\qud\testpage，<br />
在debug目录下执行<br />
.class文件打jar包命令：</p>
<pre><code>jar -cvf class.jar com -- jar包会生成在当前目录下</code></pre>
<p>打jar包的时候要去掉R文件以及其他不需要的class文件，因为unity也会根据res下的目录和文件生成R文件</p>
<h3 id="安卓包解压后的目录结构"> 4.安卓包解压后的目录结构</h3>
<p>安卓打包apk的解压目录(最简包，什么都不包括）<br />
<img src="http://www.sunxvming.com/imgs/01510f2c-ca36-46a6-912c-b48144ff0399.png" /><br />
unity打包的解压目录<br />
<img src="http://www.sunxvming.com/imgs/eceac7b0-cbb9-4627-aef7-78ae39b3153d.png" /><br />
多的内容为asserts和lib目录，lib中的内容如下:<br />
libmain.so libmono.so libunity.so</p>
<h3 id="android资源文件"> 5.android资源文件</h3>
<p>Android资源文件大致可以分为两种：<br />
一：res目录下存放的可编译的资源文件：<br />
这种资源文件系统会在R.java里面自动生成该资源文件的ID，所以访问这种资源文件比较简单，通过R.XXX.ID即可；<br />
二：assets目录下存放的原生资源文件：<br />
因为系统在编译的时候不会编译assets下的资源文件，所以我们不能通过R.XXX.ID的方式访问它们。那我么能不能通过该资源的绝对路径去访问它们呢？因为apk安装之后会放在/data/app/**.apk目录下，以apk形式存在，asset/res和被绑定在apk里，并不会解压到/data/data/YourApp目录下去，所以我们无法直接获取到assets的绝对路径，因为它们根本就没有。<br />
还好Android系统为我们提供了一个AssetManager工具类。list返回文件列表 open打开指定文件的文件流</p>
<h3 id="android工程作为插件导入untiy"> 6.android工程作为插件导入untiy</h3>
<p>文件结构如下：</p>
<pre><code>Assets
 Plugins
  Android
   bin --目录下放编译后的class文件
   res -- 放android工程的res文件
   AndroidManifest.xml</code></pre>
<p>untiy在打包的时候会在项目的Temp目录下生成临时文件以进行打包操作，若碰到奇怪问题，把目录下的文件都删除试试。</p>
<h3 id="studio-gradle构建工具报错"> 7.studio gradle构建工具报错</h3>
<pre><code>gradle project sync failed.Basic functionality(e.g.editing,debugging) will not work properly.</code></pre>
<p>解决方案：进入项目目录下，找到 gradle\wrapper\gradle-wrapper.properties 文件，记事本打开，内容如下：</p>
<pre><code>#Sun Sep 04 23:25:42 CST 2016
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
distributionUrl=https://services.gradle.org/distributions/gradle-2.14.1-all.zip</code></pre>
<p>最后一句，https://services.gradle.org/distributions/gradle-2.14.1-all.zip<br />
studio会下载上面的Gradle，不知道什么原因下载不下来，我们可以手动下载这个版本的Gradle，无需解压直接拷贝到<br />
C:\Users\qud.gradle\wrapper\dists\gradle-3.3-all\55gk2rcmfc6p2dg9u9ohc3hw9下即可，重启studio，问题解决</p>
<h2 id="三打包时可能会遇到问题"> 三：打包时可能会遇到问题</h2>
<h3 id="tools版本太高"> 1.tools版本太高</h3>
<p>打包是报如下错误：<br />
<img src="http://www.sunxvming.com/imgs/4a163601-9145-4035-bc64-4b90933c5962.png" /></p>
<pre><code>Error:Invalid command android
UnityEditor.BuildPlayerWindow:BuildPlayerAndRun()</code></pre>
<p>原因是<br />
Unity在编译时会调用Android SDK tools中的android命令，而在新版本的Android SDK tools 中，android这个命令已经废弃了，导致Unity 无法正常编译。所以下载一个旧版本的tools就行，然后替换下面的目录就行<br />
<img src="http://www.sunxvming.com/imgs/ae8be862-4763-4e9f-8bf2-3b6cf1965cab.png" /><br />
换成tools_r25.2.3-windows.zip 这版本的就不会报错了。</p>
<h2 id="四如何一键打包"> 四：如何一键打包</h2>
<h3 id="apk自动打包脚本"> 1.apk自动打包脚本</h3>
<p>bat脚本，功能是在命令行下，调用unity编辑器中自定义的打apk包的c#的方法。</p>
<pre><code>@echo off
del /f /s /q %cd%\build-android-exe-output\*.*
echo build start: %time%
set UNITY_PATH=%UnityPath%
set UNITY_LOG_PATH=%cd%\build-android-exe-output\unity_log.txt
set EXPORT_PATH=%cd%\build-android-exe-output\rise.apk
set Local_Path=%cd%\..\client
cd %Local_Path%
set UNITY_PROJECT_PATH=%cd%
cd ..
:: 隐藏 Assets\Resources
attrib +h %Local_Path%\Assets\Resources\*.* /S /D
set UNITY_METHOD_NAME=RiseTool.BuildAndroidAPK
svn revert -R %UNITY_PROJECT_PATH%
svn cleanup --remove-unversioned %UNITY_PROJECT_PATH%
svn cleanup --remove-ignored %UNITY_PROJECT_PATH%\Assets\StreamingAssets
%UNITY_PATH% -quit -batchmode -logFile %UNITY_LOG_PATH% -projectPath %UNITY_PROJECT_PATH% -executeMethod %UNITY_METHOD_NAME% -outputPath %EXPORT_PATH%
if %errorlevel% == 0 (echo successed ) else (echo fail please see unity_log.txt)
echo build end: %time%
pause</code></pre>
<p>C#中对应的打apk包的方法</p>
<pre><code>    [MenuItem(&quot;Tools/打版/android打apk包&quot;)]
    public static void BuildAndroidAPK()
    {
        string outputPath = EditorConfig.buildPath + &quot;build-android-exe-output/rise.exe&quot;;
        string[] ss = System.Environment.GetCommandLineArgs();
        for (int i = 0; i &lt; ss.Length; i++)
        {
            if (ss[i] == &quot;-outputPath&quot;)
            {
                outputPath = ss[i + 1];
            }
        }
        outputPath = outputPath.Replace(&#39;\\&#39;, &#39;/&#39;);
        List&lt;string&gt; levels = new List&lt;string&gt;();
        foreach (EditorBuildSettingsScene scene in EditorBuildSettings.scenes)
        {
            if (!scene.enabled) continue;
            levels.Add(scene.path);
        }
        EditorUserBuildSettings.SwitchActiveBuildTarget(BuildTargetGroup.Android, BuildTarget.Android);
        PlayerSettings.applicationIdentifier = &quot;com.qudao.rise&quot;;
        EditorUserBuildSettings.development = true;
        EditorUserBuildSettings.allowDebugging = true;
        EditorUserBuildSettings.connectProfiler = true;
        PlayerSettings.MTRendering = true;
        string res = BuildPipeline.BuildPlayer(levels.ToArray(), outputPath, BuildTarget.Android, BuildOptions.None);
        if (res.Length &gt; 0)
            throw new Exception(&quot;BuildPlayer failure: &quot; + res);
    }</code></pre>
<h3 id="ab包自动打包脚本"> 2.ab包自动打包脚本</h3>
<p>于上面的bat脚本类似，也是在命令行里掉unity编辑器中的C#方法</p>
<pre><code>@echo off
echo build start: %time%
set UNITY_PATH=%UnityPath%
set UNITY_LOG_PATH=%cd%\build-android-ab-output\unity_log.txt
set Local_Path=%cd%\..\client\
cd %Local_Path%
set UNITY_PROJECT_PATH=%cd%
cd ..
set UNITY_METHOD_NAME=RiseTool.BuildAndroid
svn revert -R %UNITY_PROJECT_PATH%
svn cleanup --remove-unversioned %UNITY_PROJECT_PATH%
svn cleanup --remove-ignored %UNITY_PROJECT_PATH%\Assets\StreamingAssets
%UNITY_PATH% -quit -batchmode -logFile %UNITY_LOG_PATH% -projectPath %UNITY_PROJECT_PATH% -executeMethod %UNITY_METHOD_NAME%
if %errorlevel% == 0 (echo successed ) else (echo fail please see unity_log.txt)
echo build end: %time%
pause</code></pre>
<p>打ab包的逻辑比较复杂，在这里就不全部列出所有代码了</p>
<pre><code>[MenuItem(&quot;Tools/打版/android打ab包&quot;)]
public static void BuildAndroid()
{
 EditorSceneManager.OpenScene(&quot;Assets/Scenes/game.unity&quot;);
 byteKind = 32;
 //BuildByteCode();
 BuildAltas(BuildTarget.Android);
 // ReplaceAlphaTex();
 // GenImageSetFile(BuildTarget.Android);
 // TextureImportSetting.SetImageSetImportFormat(BuildTarget.Android);
 // AndroidAddMatTool.PrefabAddMat();
 CreateAssetBundle.BuildAndroid();
}</code></pre>
<h2 id="五如何真机调试"> 五：如何真机调试</h2>
<p>1.手机的开发者模式打开用调试模式<br />
2.在device monitor中不显示手机的话，可以下载一个豌豆荚然后会自动装驱动，之后就可以连接上device monitor了 3.看文件时看不了，是因为需要root权限，手机的su一般是被干掉的，可以下载一个一键root的软件工具，然后su root</p>

<footer id="colophon" >
		<div class="site-info col">
			Powered by <a href="https://github.com/sunxvming/my-blog">my-blog</a>
			<span class="sep"> | </span>
				<span><a target="_blank" href="http://beian.miit.gov.cn">【京ICP备19018538号】</a></span>
			<span><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502037753">【京公网安备 11010502037753号】</a></span>
		</div><!-- .site-info col -->
        <div class="site-info col"> This page is hosted at <a target="_blank" href="https://github.com/sunxvming">Github</a>.To see the source code you can visit the <a target="_blank" href="https://github.com/sunxvming/my-blog">repo</a> and I'd be glad if you like and star it.</div>
</footer>
</div> <!--wrapper-->
</body>
</html>
