<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta name="generator" content="pandoc" />




<link rel="stylesheet" href="../../../.././css/style.css" />




<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Saira+Semi+Condensed%3A400%2C700&ver=4.9.18" type="text/css" />

<script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script>
jQuery(document).ready(function(){
    jQuery('pre').each(function(){
        var el = jQuery(this).find('code');
        var code_block = el.html(); 
 
        if (el.length > 0) { 
            jQuery(this).addClass('prettyprint').html(code_block).attr('style', 'max-height:450px');
        } else { 
            jQuery(this).removeClass().addClass('prettyprint'); 
        }
    });
});
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?skin=desert"></script>

</head>


<body>
<div id="wrapper">


<style type="text/css">

#masthead .site-branding {
    margin-bottom: 7px;
}

#masthead .site-branding .site-title {
    font-size: 2.2rem;
    line-height: 1;
    text-transform: uppercase;
    margin: 0;
    margin-bottom: 0.5rem;
}


#masthead .site-description{
	margin:0px;
}




#masthead .site-branding .site-title a {
    display: inline-block;
    position: relative;
    top: -11px;
}

#masthead  a {
    <!-- color: #007bff; -->
    text-decoration: none;
    background-color: transparent;
}



.io-menu-desktop {
    display: block;
    text-align: right;
}
.io-menu-desktop span.io-menu-button-span {
    display: none;
}
.io-menu-desktop ul {
    padding: 0;
    margin: 0;
    list-style: none;
    background: transparent;
    display: block;
}
.io-menu-desktop ul > li {
    margin-right: -4px;
    display: inline-block;
    position: relative;
    height: 30px;
    color: #212529;
    font-size: 12px;
    text-transform: uppercase;
    text-shadow: 0 0 0 rgb(0 0 0 / 0%);
    font-weight: 400;
}
.io-menu-desktop ul > li > a {
    padding: 0;
    line-height: 29px;
    padding-left: 20px;
    padding-right: 20px;
    padding-top: 1px;
    color: #212529;
    font-size: 12px;
    text-transform: uppercase;
    text-shadow: 0 0 0 rgb(0 0 0 / 0%);
    font-weight: 400;
}
.io-menu-desktop a {
    display: block;
    -o-transition: none;
    -moz-transition: none;
    -webkit-transition: none;
    transition: none;
}
.io-menu-desktop > ul > li.current-menu-item > a, .io-menu-desktop > div > ul > li.current-menu-item > a {
    background: rgba(0, 0, 0, 0.01);
}



#colophon {
    margin-top: 70px;
    margin-bottom: 30px;
}
#colophon .site-info {
    text-align: center;
}

</style>


<header id="masthead" class="site-header row">
    <div class="site-branding col-sm-6">
        <span class="site-title" style="font-size: 2.2rem">
            <span>
                <img width="60px" height="60px"
                    src="https://sxm-upload.oss-cn-beijing.aliyuncs.com/imgs/16833443.jpg">
            </span>


            <a href="http://www.sunxvming.com/" rel="home">忧郁的大能猫</a>
        </span>
        <p class="site-description">好奇的探索者，理性的思考者，踏实的行动者。</p>
    </div><!-- .site-branding -->

    <nav id="site-navigation" class="main-navigation col-sm-9">
        <div class="io-menu io-menu-desktop"><span class="io-menu-button io-menu-button-span">≡</span>

            <div class="menu-%e4%b8%bb%e8%8f%9c%e5%8d%95-container">
                <ul id="primary-menu" class="menu">
                    <li id="menu-item-38"
                        class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item-38">
                        <a href="http://www.sunxvming.com">首页</a></li>
                    <li id="menu-item-175"
                        class="menu-item menu-item-type-post_type menu-item-object-page menu-item-175"><a
                            href="http://www.sunxvming.com/">所有文章</a></li>
                    <li id="menu-item-176"
                        class="menu-item menu-item-type-post_type menu-item-object-page menu-item-176"><a
                            href="http://www.sunxvming.com/blog/about-me.html">关于俺</a></li>
                </ul>
            </div>
        </div><!-- .io-menu -->
    </nav><!-- #site-navigation -->
</header>

<div id="header">
<h1 class="title">blog/A-IT/10-编程语言/php/cookie和session</h1>
</div> <!--id="header"-->
 <!--if(title)-->

<p>Table of Contents:</p>
<div id="TOC">
<ul>
<li><a href="#一cookie">一、COOKIE</a>
<ul>
<li><a href="#cookie工作机理">cookie工作机理:</a></li>
<li><a href="#设置cookie">设置cookie:</a></li>
<li><a href="#cookie的读取">Cookie的读取:</a></li>
<li><a href="#删除cookie">删除cookie</a></li>
<li><a href="#常见问题解决">常见问题解决:</a></li>
</ul></li>
<li><a href="#二php的session">二、PHP的Session</a>
<ul>
<li><a href="#sessionid的传送">sessionID的传送</a></li>
<li><a href="#session基本用法实例">session基本用法实例</a></li>
<li><a href="#session在php大型web应用中的使用">session在PHP大型web应用中的使用</a></li>
<li><a href="#session安全问题">session安全问题</a></li>
</ul></li>
<li><a href="#cookie和session的登录流程">cookie和session的登录流程</a></li>
</ul>
</div>
 <!--if(toc)-->

<h2 id="一cookie">一、COOKIE</h2>
<p>cookie 是一种在远程浏览器端储存数据并以此来跟踪和识别用户的机制。<br />
PHP在http协议的头信息里发送cookie,格式类似<code>Set-Cookie:xxx</code>, 因此 <code>setcookie()</code> 函数必须在其它信息被输出到浏览器前调用，这和对 <code>header()</code> 函数的限制类似。</p>
<h3 id="cookie工作机理">cookie工作机理:</h3>
<p>1. 服务器通过随着响应发送一个http的<code>Set-Cookie</code>头,在客户机中设置一个cookie<br />
2. 客户端自动向服务器端发送一个http的cookie头,服务器接收读取.</p>
<pre><code>HTTP/1.x 200 OK
X-Powered-By: PHP/5.2.1
Set-Cookie: TestCookie=something from somewhere; path=/
Expires: Thu, 19 Nov 2007 18:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
Pragma: no-cache
Content-type: text/html</code></pre>
<p>这一行实现了cookie功能,收到这行后</p>
<pre><code>Set-Cookie: TestCookie=something from somewhere; path=/</code></pre>
<p>浏览器将在客户端的磁盘上创建一个cookie文件,并在里面写入:</p>
<pre><code>TestCookie=something from somewhere;</code></pre>
<p>这一行就是我们用<code>setcookie('TestCookie','something from somewhere','/');</code>的结果.<br />
也就是用<code>header('Set-Cookie: TestCookie=something from somewhere; path=/');</code>的结果.</p>
<h3 id="设置cookie">设置cookie:</h3>
<p>可以用 <code>setcookie()</code> 或 <code>setrawcookie()</code> 函数来设置 cookie。也可以通过向客户端直接发送http头来设置.</p>
<p><strong>使用setcookie()函数设置cookie</strong></p>
<pre><code>&lt;?php
$value = &#39;something from somewhere&#39;;
setcookie(&quot;TestCookie&quot;, $value); /* 简单cookie设置 */
setcookie(&quot;TestCookie&quot;, $value, time()+3600); /* 有效期1个小时 */
setcookie(&quot;TestCookie&quot;, $value, time()+3600, &quot;/~rasmus/&quot;, &quot;.example.com&quot;, 1); /* 有效目录 /~rasmus,有效域名example.com及其所有子域名 */
?&gt;</code></pre>
<p><strong>使用header()设置cookie</strong></p>
<pre><code>header(&quot;Set-Cookie: name=$value[;path=$path[;domain=xxx.com[;]]&quot;);</code></pre>
<p>后面的参数和上面列出setcookie函数的参数一样.</p>
<h3 id="cookie的读取">Cookie的读取:</h3>
<p>直接用php内置超级全局变量 <code>$_COOKIE</code>就可以读取浏览器端的cookie,这个相当于php自动帮你做了从http头中解析cookie的功能。</p>
<pre><code>print $_COOKIE[&#39;TestCookie&#39;];</code></pre>
<h3 id="删除cookie">删除cookie</h3>
<p>只需把有效时间设为小于当前时间, 和把值设置为空.例如:</p>
<pre><code>setcookie(&quot;name&quot;,&quot;&quot;,time()-1);</code></pre>
<p>用header()类似.</p>
<h3 id="常见问题解决">常见问题解决:</h3>
<p>1. 用setcookie()时有错误提示,可能是因为调用setcookie()前面有输出或空格.也可能你的文档使从其他字符集转换过来,文档后面可能带有BOM签名(就是在文件内容添加一些隐藏的BOM字符).解决的办法就是使你的文档不出现这种情况.还有通过使用ob_start()函数有也能处理一点.<br />
2. <code>$_COOKIE</code>受magic_quotes_gpc影响,可能自动转义<br />
3. 使用的时候,有必要测试用户是否支持cookie,有用户是禁用cookie的</p>
<h2 id="二php的session">二、PHP的Session</h2>
<p>访问网站的来客会被分配一个唯一的标识符，即所谓的会话ID。它要么存放在客户端的cookie，要么经由 URL 传递。<br />
当来客访问网站时，PHP 会自动（如果 session.auto_start 被设为 1）或在用户请求时（由 session_start() 明确调用或 session_register() 暗中调用）<strong>检查请求中</strong>是否发送了特定的会话 ID。如果是，则之前保存的环境就被重建。</p>
<h3 id="sessionid的传送">sessionID的传送</h3>
<p>通过cookie传送sessin ID<br />
使用session_start()调用session,服务器端在生成session文件的同时,生成session ID哈希值和默认值为PHPSESSID的session name,并向客户端发送变量为(默认的是)PHPSESSID(session name),值为一个128位的哈希值.服务器端将通过该cookie与客户端进行交互.</p>
<h3 id="session基本用法实例">session基本用法实例</h3>
<pre><code>// page1.php
&lt;?php
session_start();
echo &#39;Welcome to page #1&#39;;
/* 创建session变量并给session变量赋值 */
$_SESSION[&#39;favcolor&#39;] = &#39;green&#39;;
$_SESSION[&#39;animal&#39;] = &#39;cat&#39;;
$_SESSION[&#39;time&#39;] = time();

// 跳转到page2之后依然可以获取session的值
echo &#39;&lt;br /&gt;&lt;a href=&quot;page2.php&quot;&gt;page 2&lt;/a&gt;&#39;;
?&gt;

// page2.php
&lt;?php
session_start();
print $_SESSION[&#39;animal&#39;]; // 打印出单个session
var_dump($_SESSION); // 打印出page1.php传过来的session值
?&gt;</code></pre>
<p><strong>删除session</strong></p>
<pre><code>// 要三步实现.
session_destroy(); // 第一步: 删除服务器端session文件,这使用
setcookie(session_name(),&#39;&#39;,time()-3600); // 第二步: 删除实际的session:
$_SESSION = array(); // 第三步: 删除$_SESSION全局变量数组</code></pre>
<h3 id="session在php大型web应用中的使用">session在PHP大型web应用中的使用</h3>
<p>对于访问量大的站点,用默认的session存贮方式并不适合,目前最优的方法是用数据库存取session.这时,函数<br />
<code>bool session_set_save_handler ( callback open, callback close, callback read, callback write, callback destroy, callback gc )</code><br />
就是提供给我们解决这个问题的方案.</p>
<p>该函数使用的6个函数如下:</p>
<pre><code>1. bool open() 用来打开会话存储机制,
2. bool close() 关闭会话存储操作.
3. mixde read() 从存储中装在session数据时使用这个函数
4. bool write() 将给定session ID的所有数据写到存储中
5. bool destroy() 破坏与指定的会话ID相关联的数据
6. bool gc() 对存储系统中的数据进行垃圾收集</code></pre>
<p>例子见php手册<code>session_set_save_handler()</code> 函数.<br />
如果用类来处理,调用className类中的6个静态方法.</p>
<pre><code>session_set_save_handler(
    array(&#39;className&#39;,&#39;open&#39;),
    array(&#39;className&#39;,&#39;close&#39;),
    array(&#39;className&#39;,&#39;read&#39;),
    array(&#39;className&#39;,&#39;write&#39;),
    array(&#39;className&#39;,&#39;destroy&#39;),
    array(&#39;className&#39;,&#39;gc&#39;),
)</code></pre>
<p><strong>常用session函数</strong></p>
<pre><code>bool session_start(void); 初始化session
bool session_destroy(void): 删除服务器端session关联文件。
string session_id() 当前session的id
string session_name() 当前存取的session名称,也就是客户端保存session ID的cookie名称.默认PHPSESSID。
array session_get_cookie_params() 与这个session相关联的session的细节.
string session_cache_limiter() 控制使用session的页面的客户端缓存
ini session_cache_expire() 控制客户端缓存时间
bool session_destroy() 删除服务器端保存session信息的文件
void session_set_cookie_params ( int lifetime [, string path [, string domain [, bool secure [, bool httponly]]]] )设置与这个session相关联的session的细节
bool session_set_save_handler ( callback open, callback close, callback read, callback write, callback destroy, callback gc )定义处理session的函数,(不是使用默认的方式)
bool session_regenerate_id([bool delete_old_session]) 分配新的session id</code></pre>
<h3 id="session安全问题">session安全问题</h3>
<p>攻击者通过投入很大的精力尝试获得现有用户的有效会话ID,有了会话id,他们就有可能能够在系统中拥有与此用户相同的能力.<br />
因此,我们主要解决的思路是<strong>效验session ID的有效性</strong>.</p>
<pre><code>&lt;?php
/**
 * 效验session的合法性
 */
function sessionVerify() {
    if(!isset($_SESSION[&#39;user_agent&#39;])){
        $_SESSION[&#39;user_agent&#39;] = MD5($_SERVER[&#39;REMOTE_ADDR&#39;] . $_SERVER[&#39;HTTP_USER_AGENT&#39;]);
    }
    /* 如果用户session ID是伪造,则重新分配session ID */
    elseif ($_SESSION[&#39;user_agent&#39;] != MD5($_SERVER[&#39;REMOTE_ADDR&#39;]  . $_SERVER[&#39;HTTP_USER_AGENT&#39;])) {
        session_regenerate_id();
    }
}


/**
 * 销毁session
 * 三步完美实现,不可漏
 *
 */
function sessionDestroy() {
    session_destroy();
    setcookie(session_name(),&#39;&#39;,time()-3600);
    $_SESSION = array();
}
?&gt;</code></pre>
<p>注明:<br />
session的保存数据的时候，是通过系列化<code>$_SESSION</code>数组来存贮，所以有系列化所拥有的问题，可能有特殊字符的值要用base64_encode函数编码，读取的时候再用base64_decode解码</p>
<p><strong>SESSION 的数据保存在哪里呢？</strong></p>
<p>当然是在服务器端，但不是保存在内存中，而是保存在文件或数据库中。<br />
默认情况下，php.ini 中设置的 SESSION 保存方式是 files（session.save_handler = files），即使用读写文件的方式保存 SESSION 数据，而 SESSION 文件保存的目录由 session.save_path 指定，文件名以 sess_ 为前缀，后跟 SESSION ID，如：sess_c72665af28a8b14c0fe11afe3b59b51b。文件中的数据即是序列化之后的 SESSION 数据了。</p>
<p>如果访问量大，可能产生的 SESSION 文件会比较多，这时可以设置分级目录进行 SESSION 文件的保存，效率会提高很多，设置方法为：session.save_path="N;/save_path"，N 为分级的级数，save_path 为开始目录。<br />
当写入 SESSION 数据的时候，PHP 会获取到客户端的 SESSION_ID，然后根据这个 SESSION ID 到指定的 SESSION 文件保存目录中找到相应的 SESSION 文件，不存在则创建之，最后将数据序列化之后写入文件。读取 SESSION 数据是也是类似的操作流程，对读出来的数据需要进行解序列化，生成相应的 SESSION 变量。</p>
<p>当然如果压力大的话，可以存储在redis上，就没有什么压力了。</p>
<h2 id="cookie和session的登录流程">cookie和session的登录流程</h2>
<p>1. 用户输入用户名、密码、验证码进行登录<br />
2. 服务器验证用户登录信息后：<br />
* 生产sessionid<br />
* 往此需要的信息写入到此session<br />
* 将session的内容会序列化成字符串或者二进制保存在文件或者数据库中<br />
* 返回的http头中设置sessionid，例如<code>set-cookie:PHPSESSID=xxxxxxx</code>，作用是将seesionid设置到浏览器的cookie中<br />
3. 浏览器保存sessionid到cookie中<br />
4. 浏览器再次请求其他页面时，将sessionid设置到http的头中并发送请求<br />
5. 服务器接收到请求后，读取sessionid，并根据这个PHPSESSID查询服务器上有没有对应的session内容，如果有则将其对应的值取出、进行反序列序列化并将值设置到某个对象上。比如php中的是设置到<code>$_SESSION</code>数组中。一般这个步骤由框架和编程语言自动完成。程序中可以直接使用session的值</p>

<footer id="colophon" >
		<div class="site-info col">
			Powered by <a href="https://github.com/sunxvming/my-blog">my-blog</a>
			<span class="sep"> | </span>
				<span><a target="_blank" href="http://beian.miit.gov.cn">【京ICP备19018538号】</a></span>
			<span><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502037753">【京公网安备 11010502037753号】</a></span>
		</div><!-- .site-info col -->
        <div class="site-info col"> This page is hosted at <a target="_blank" href="https://github.com/sunxvming">Github</a>.To see the source code you can visit the <a target="_blank" href="https://github.com/sunxvming/my-blog">repo</a> and I'd be glad if you like and star it.</div>
</footer>
</div> <!--wrapper-->
</body>
</html>
